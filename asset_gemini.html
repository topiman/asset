<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>v8 - 个人资产看板 (完整配置版)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root {
      --bg-body: #0f172a; --bg-card: #1e293b; --bg-modal: #334155;
      --text-primary: #f1f5f9; --text-secondary: #94a3b8;
      --accent-blue: #38bdf8; --accent-green: #4ade80; --accent-red: #f87171;
      --border-color: #475569;
    }
    body { margin: 0; background: var(--bg-body); color: var(--text-primary); font-family: 'Segoe UI', sans-serif; }
    
    /* Header & Layout */
    header { background: var(--bg-card); padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    header h1 { margin: 0; font-size: 1.4rem; color: var(--accent-blue); }
    .header-controls { display: flex; align-items: center; gap: 15px; }
    .btn-config { background: transparent; border: 1px solid var(--accent-blue); color: var(--accent-blue); padding: 5px 12px; border-radius: 4px; cursor: pointer; transition: 0.2s; }
    .btn-config:hover { background: var(--accent-blue); color: white; }
    .total-worth-display span { color: var(--accent-green); font-weight: bold; font-size: 1.2rem; }

    .container { width: 95%; max-width: 1400px; margin: 20px auto; }
    .row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
    .col { background: var(--bg-card); border-radius: 12px; padding: 20px; flex: 1; min-width: 320px; border: 1px solid var(--border-color); }
    h3.panel-title { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; color: var(--text-secondary); }

    /* Tables & Inputs */
    .asset-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-bottom: 15px; }
    .input-group label { display: block; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px; }
    .input-group input { width: 100%; box-sizing: border-box; background: #0f172a; border: 1px solid var(--border-color); color: white; padding: 6px; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { padding: 8px; border-bottom: 1px solid var(--border-color); text-align: left; }
    th { color: var(--text-secondary); }
    .val-cell { font-family: 'Consolas', monospace; }
    
    /* Status & Modal */
    .status-bar { margin-top: 10px; font-size: 0.8rem; color: var(--text-secondary); text-align: right; }
    .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #ef4444; margin-right: 5px; }
    .status-dot.active { background: #22c55e; box-shadow: 0 0 5px #22c55e; }
    .chart-box { height: 350px; position: relative; }

    /* Configuration Modal Styles */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; justify-content: center; align-items: center; }
    .modal-content { background: var(--bg-card); width: 90%; max-width: 500px; max-height: 85vh; border-radius: 12px; border: 1px solid var(--border-color); padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .close-modal { cursor: pointer; font-size: 1.5rem; color: var(--text-secondary); }
    
    .config-section { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
    .config-section h4 { color: var(--accent-blue); margin: 0 0 10px 0; }
    .config-list { list-style: none; padding: 0; margin: 0; }
    .config-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); margin-bottom: 8px; padding: 8px 12px; border-radius: 6px; }
    .btn-delete { color: var(--accent-red); cursor: pointer; transition: 0.2s; }
    .btn-delete:hover { transform: scale(1.2); }
    
    .add-row { display: flex; gap: 10px; margin-top: 10px; }
    .add-row input { flex: 1; background: #0f172a; border: 1px solid var(--border-color); color: white; padding: 8px; border-radius: 4px; }
    .btn-add { background: var(--accent-green); color: #000; border: none; padding: 0 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .btn-reset { background: #475569; color: #fff; border: none; padding: 10px; width: 100%; border-radius: 6px; cursor: pointer; margin-top: 10px; }
  </style>
</head>
<body>

  <header>
    <h1>我的资产看板 v8</h1>
    <div class="header-controls">
      <div class="total-worth-display">总净值: <span id="headerTotal">--</span></div>
      <button class="btn-config" onclick="openConfigModal()"><i class="fas fa-cog"></i> 管理配置</button>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col">
        <h3 class="panel-title">加密货币 (Crypto)</h3>
        <div class="asset-grid" id="cryptoInputs"></div>
        <table>
          <thead><tr><th>资产</th><th>价格</th><th>持仓</th><th>价值 (USD)</th></tr></thead>
          <tbody id="cryptoTableBody"></tbody>
          <tfoot><tr><td colspan="3" style="text-align:right; font-weight:bold; color:var(--accent-blue)">Total:</td><td id="cryptoTotalDisplay" style="font-weight:bold; color:var(--accent-blue)">--</td></tr></tfoot>
        </table>
        <div class="status-bar"><span id="wsDot" class="status-dot"></span><span id="wsStatusText">检查连接...</span></div>
      </div>
      <div class="col">
        <h3 class="panel-title">美股 & 现金 (Stocks)</h3>
        <div class="asset-grid" id="stockInputs"></div>
        <table>
          <thead><tr><th>代码</th><th>价格</th><th>持仓</th><th>价值 (USD)</th></tr></thead>
          <tbody id="stockTableBody"></tbody>
          <tfoot><tr><td colspan="3" style="text-align:right; font-weight:bold; color:var(--accent-blue)">Total:</td><td id="stockTotalDisplay" style="font-weight:bold; color:var(--accent-blue)">--</td></tr></tfoot>
        </table>
        <div class="status-bar"><span id="apiDot" class="status-dot"></span><span id="apiStatusText">Finnhub API</span></div>
      </div>
    </div>
    <div class="row">
      <div class="col" style="flex:2;">
        <h3 class="panel-title">资产趋势 (1年)</h3>
        <div class="chart-box"><canvas id="chartHourComb"></canvas></div>
      </div>
      <div class="col" style="flex:1;">
        <h3 class="panel-title">分布占比</h3>
        <div class="chart-box"><canvas id="chartAssetPie"></canvas></div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="configModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-edit"></i> 管理资产列表</h2>
        <span class="close-modal" onclick="closeConfigModal()">&times;</span>
      </div>

      <div class="config-section">
        <h4>加密货币</h4>
        <ul class="config-list" id="cryptoConfigList"></ul>
        <div class="add-row">
          <input type="text" id="newCryptoSymbol" placeholder="代码 (如 DOGE)">
          <button class="btn-add" onclick="addCryptoAsset()">添加</button>
        </div>
      </div>

      <div class="config-section">
        <h4>美股/现金</h4>
        <ul class="config-list" id="stockConfigList"></ul>
        <div class="add-row">
          <input type="text" id="newStockSymbol" placeholder="代码 (如 AAPL)">
          <button class="btn-add" onclick="addStockAsset()">添加</button>
        </div>
      </div>

      <button class="btn-reset" onclick="resetToDefault()">重置所有数据</button>
    </div>
  </div>

<script>
/*************************************************************
 * 1. 云端配置 (已填入你提供的正确信息)
 *************************************************************/
const JSONBIN_ID  = "694a56ccae596e708fabeac2";       
const JSONBIN_KEY = "$2a$10$ILS6zBz1bfayZ1p0fV2nw.aUVzyUXP6ZicSczS4LLMvPFuCDOY0JC";

const FINNHUB_TOKEN = "cuhf9e9r01qva71tls00cuhf9e9r01qva71tls0g";
const MAX_HOUR_LEN = 8760;

// 默认配置 (如果云端是空的，会用这个初始化)
const DEFAULT_CRYPTO = [
  { symbol: 'BTC',  wsKey: 'btcusdt' },
  { symbol: 'ETH',  wsKey: 'ethusdt' },
  { symbol: 'SOL',  wsKey: 'solusdt' },
  { symbol: 'USDT', wsKey: null, isStable: true }
];
const DEFAULT_STOCK = [
  { symbol: 'TSLA' },
  { symbol: 'NVDA' },
  { symbol: 'USD', isCash: true }
];

// 全局状态
let isDataLoaded = false;
let cryptoConfig = [], stockConfig = [], quantities = {}, prices = {}, hourlyComb = [];
let cryptoWS = null, chartLine, chartPie, stockInterval = null;

// 简易 DOM 选择器
const $el = (id) => document.getElementById(id);

/*************************************************************
 * 2. 核心: 云端加载与保存
 *************************************************************/
async function loadConfig() {
  $el('wsStatusText').textContent = '连接云端...';
  
  try {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_ID}/latest`, {
      headers: { 'X-Master-Key': JSONBIN_KEY }
    });

    if (!res.ok) throw new Error("连接失败: " + res.status);
    
    const json = await res.json();
    const data = json.record; 

    // 智能合并：如果云端没有 config (比如是空 Bin)，则使用 DEFAULT
    cryptoConfig = (data.cryptoConfig && data.cryptoConfig.length > 0) ? data.cryptoConfig : JSON.parse(JSON.stringify(DEFAULT_CRYPTO));
    stockConfig  = (data.stockConfig && data.stockConfig.length > 0) ? data.stockConfig : JSON.parse(JSON.stringify(DEFAULT_STOCK));
    quantities   = data.quantities || {};
    hourlyComb   = data.hourlyComb || [];

    // 初始化价格字典
    [...cryptoConfig, ...stockConfig].forEach(item => {
      const k = item.symbol.toLowerCase();
      if (quantities[k] === undefined) quantities[k] = 0;
      if (item.isStable || item.isCash) prices[k] = 1;
      else if (!prices[k]) prices[k] = 0;
    });

    isDataLoaded = true;
    renderUI();
    restartServices();
    initCharts(); 
    $el('wsStatusText').textContent = '云端同步正常';

    // 如果是用默认值初始化的，顺手保存回云端，防止下次读到空的
    if (!data.cryptoConfig) {
      saveToCloud();
    }

  } catch (err) {
    console.error(err);
    $el('wsStatusText').textContent = '离线模式';
    alert("读取云端失败: " + err.message + "\n将加载默认配置。");
    // 降级
    cryptoConfig = JSON.parse(JSON.stringify(DEFAULT_CRYPTO));
    stockConfig = JSON.parse(JSON.stringify(DEFAULT_STOCK));
    isDataLoaded = true;
    renderUI();
    restartServices();
    initCharts();
  }
}

async function saveToCloud() {
  if (!isDataLoaded) return;
  const payload = { cryptoConfig, stockConfig, quantities, hourlyComb };
  try {
    await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_ID}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_KEY },
      body: JSON.stringify(payload)
    });
    console.log('云端已保存');
  } catch(e) { console.error('保存失败', e); }
}

/*************************************************************
 * 3. 界面渲染
 *************************************************************/
function renderUI() {
  // Render Crypto
  const cIn = $el('cryptoInputs'); cIn.innerHTML = '';
  const cTb = $el('cryptoTableBody'); cTb.innerHTML = '';
  cryptoConfig.forEach(c => {
    const k = c.symbol.toLowerCase();
    cIn.insertAdjacentHTML('beforeend', `<div class="input-group"><label>${c.symbol}</label><input type="number" step="any" data-key="${k}" value="${quantities[k]}"></div>`);
    cTb.insertAdjacentHTML('beforeend', `<tr><td><b>${c.symbol}</b></td><td class="val-cell" id="p_${k}">--</td><td class="val-cell" id="q_${k}">${quantities[k]}</td><td class="val-cell" id="v_${k}">--</td></tr>`);
  });

  // Render Stocks
  const sIn = $el('stockInputs'); sIn.innerHTML = '';
  const sTb = $el('stockTableBody'); sTb.innerHTML = '';
  stockConfig.forEach(s => {
    const k = s.symbol.toLowerCase();
    sIn.insertAdjacentHTML('beforeend', `<div class="input-group"><label>${s.symbol}</label><input type="number" step="any" data-key="${k}" value="${quantities[k]}"></div>`);
    sTb.insertAdjacentHTML('beforeend', `<tr><td><b>${s.symbol}</b></td><td class="val-cell" id="p_${k}">${s.isCash?'1.00':'--'}</td><td class="val-cell" id="q_${k}">${quantities[k]}</td><td class="val-cell" id="v_${k}">--</td></tr>`);
  });

  // Re-bind Events
  document.querySelectorAll('input[type="number"]').forEach(el => {
    el.oninput = function() {
      const k = this.getAttribute('data-key');
      quantities[k] = parseFloat(this.value) || 0;
      if($el(`q_${k}`)) $el(`q_${k}`).textContent = quantities[k];
      recalc();
      saveToCloud();
    };
  });
  recalc();
}

function recalc() {
  let cTotal = 0, sTotal = 0;
  
  cryptoConfig.forEach(c => {
    const k = c.symbol.toLowerCase();
    const p = prices[k]||0; const q = quantities[k]||0;
    const v = p*q;
    cTotal += v;
    if($el(`p_${k}`)) $el(`p_${k}`).textContent = p>0 ? p.toFixed(p<1?4:2) : '--';
    if($el(`v_${k}`)) $el(`v_${k}`).textContent = v.toFixed(2);
  });

  stockConfig.forEach(s => {
    const k = s.symbol.toLowerCase();
    const p = prices[k]||0; const q = quantities[k]||0;
    const v = p*q;
    sTotal += v;
    if(!s.isCash && $el(`p_${k}`)) $el(`p_${k}`).textContent = p>0?p.toFixed(2):'--';
    if($el(`v_${k}`)) $el(`v_${k}`).textContent = v.toFixed(2);
  });

  const all = cTotal + sTotal;
  $el('cryptoTotalDisplay').textContent = cTotal.toFixed(2);
  $el('stockTotalDisplay').textContent = sTotal.toFixed(2);
  $el('headerTotal').textContent = all.toLocaleString('en-US',{style:'currency',currency:'USD'});
  
  updatePieChart(all);
}

/*************************************************************
 * 4. 配置管理 (Modal Logic Restored)
 *************************************************************/
function openConfigModal() { 
  $el('configModal').style.display = 'flex'; 
  renderConfigList(); 
}
function closeConfigModal() { 
  $el('configModal').style.display = 'none'; 
}

function renderConfigList() {
  const cList = $el('cryptoConfigList'); cList.innerHTML = '';
  cryptoConfig.forEach((item, idx) => {
    cList.insertAdjacentHTML('beforeend', `
      <li class="config-item">
        <span>${item.symbol}</span>
        ${item.symbol!=='USDT' ? `<i class="fas fa-trash-alt btn-delete" onclick="removeCrypto(${idx})"></i>` : ''}
      </li>
    `);
  });

  const sList = $el('stockConfigList'); sList.innerHTML = '';
  stockConfig.forEach((item, idx) => {
    sList.insertAdjacentHTML('beforeend', `
      <li class="config-item">
        <span>${item.symbol}</span>
        ${item.symbol!=='USD' ? `<i class="fas fa-trash-alt btn-delete" onclick="removeStock(${idx})"></i>` : ''}
      </li>
    `);
  });
}

function addCryptoAsset() {
  const input = $el('newCryptoSymbol');
  const sym = input.value.toUpperCase().trim();
  if(!sym) return;
  if(cryptoConfig.find(c => c.symbol === sym)) { alert('已存在'); return; }
  cryptoConfig.push({ symbol: sym, wsKey: sym.toLowerCase() + 'usdt' });
  input.value = '';
  renderConfigList(); saveToCloud(); renderUI(); restartServices();
}
function removeCrypto(idx) { 
  cryptoConfig.splice(idx, 1); 
  renderConfigList(); saveToCloud(); renderUI(); restartServices();
}

function addStockAsset() {
  const input = $el('newStockSymbol');
  const sym = input.value.toUpperCase().trim();
  if(!sym) return;
  if(stockConfig.find(s => s.symbol === sym)) { alert('已存在'); return; }
  stockConfig.push({ symbol: sym });
  input.value = '';
  renderConfigList(); saveToCloud(); renderUI(); restartServices();
}
function removeStock(idx) { 
  stockConfig.splice(idx, 1); 
  renderConfigList(); saveToCloud(); renderUI(); restartServices();
}

function resetToDefault() {
  if(confirm('确定要重置所有数据吗？这会清空你当前的持仓和列表。')) {
    cryptoConfig = JSON.parse(JSON.stringify(DEFAULT_CRYPTO));
    stockConfig = JSON.parse(JSON.stringify(DEFAULT_STOCK));
    quantities = {};
    saveToCloud();
    location.reload();
  }
}

/*************************************************************
 * 5. 服务与图表
 *************************************************************/
function restartServices() {
  if(cryptoWS) cryptoWS.close();
  const streams = cryptoConfig.filter(c => c.wsKey).map(c => c.wsKey + '@ticker').join('/');
  if(streams) {
    $el('wsStatusText').textContent = '连接中...'; $el('wsDot').classList.remove('active');
    cryptoWS = new WebSocket("wss://stream.binance.com:9443/stream?streams=" + streams);
    cryptoWS.onopen = () => { $el('wsStatusText').textContent = 'Live'; $el('wsDot').classList.add('active'); };
    cryptoWS.onmessage = (evt) => {
      try {
        const msg = JSON.parse(evt.data);
        const symbol = cryptoConfig.find(c => c.wsKey && msg.stream.includes(c.wsKey));
        if(symbol) { prices[symbol.symbol.toLowerCase()] = parseFloat(msg.data.c); recalc(); }
      } catch(e){}
    };
  }

  if(stockInterval) clearInterval(stockInterval);
  fetchStocks();
  stockInterval = setInterval(fetchStocks, 30000);
}

async function fetchStocks() {
  $el('apiDot').classList.remove('active');
  const symbols = stockConfig.filter(s => !s.isCash).map(s => s.symbol);
  if(symbols.length === 0) return;
  const promises = symbols.map(sym => fetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${FINNHUB_TOKEN}`).then(r=>r.json()).then(d=>({s:sym, p:d.c})).catch(()=>null));
  (await Promise.all(promises)).forEach(r => { if(r && r.p) prices[r.s.toLowerCase()] = r.p; });
  $el('apiDot').classList.add('active');
  recalc();
}

function initCharts() {
  if(chartLine) chartLine.destroy();
  if(chartPie) chartPie.destroy();

  chartLine = new Chart($el('chartHourComb').getContext('2d'), {
    type: 'line',
    data: { datasets: [{ label: '总资产', data: hourlyComb, borderColor: '#38bdf8', backgroundColor: 'rgba(56, 189, 248, 0.1)', fill: true, tension: 0.4, parsing: { xAxisKey: 'x', yAxisKey: 'y' } }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { position: 'right' } } }
  });

  chartPie = new Chart($el('chartAssetPie').getContext('2d'), {
    type: 'doughnut',
    data: { labels: [], datasets: [{ data: [], borderWidth: 0, backgroundColor: ['#38bdf8','#4ade80','#fbbf24','#f87171','#a78bfa','#2dd4bf','#fb923c','#94a3b8'] }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, color: '#94a3b8' } }, tooltip: { callbacks: { label: function(ctx) {
      let l = ctx.label || ''; if (l) l += ': ';
      const v = ctx.parsed; const t = ctx.dataset.data.reduce((a, b) => a + b, 0);
      return `${l}${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(v)} (${t>0?((v/t)*100).toFixed(1)+'%':'0%'})`;
    } } } } }
  });
}

function updatePieChart(total) {
  if(!chartPie) return;
  let labels = [], data = [];
  [...cryptoConfig, ...stockConfig].forEach(item => {
    const k = item.symbol.toLowerCase();
    const v = (prices[k]||0) * (quantities[k]||0);
    if(v > 10) { labels.push(item.symbol); data.push(v); }
  });
  chartPie.data.labels = labels; chartPie.data.datasets[0].data = data; chartPie.update();
  
  const d = new Date();
  const label = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()} ${d.getHours()}:00`;
  if(!hourlyComb.length || hourlyComb[hourlyComb.length-1].x !== label) {
    hourlyComb.push({ x: label, y: total });
    if(hourlyComb.length > MAX_HOUR_LEN) hourlyComb.shift();
    chartLine.data.datasets[0].data = hourlyComb;
    chartLine.update();
    saveToCloud();
  }
}

window.onload = loadConfig;
</script>
</body>
</html>
