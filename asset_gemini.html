<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>v7 - 个人资产看板 (智能修复版)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    /* 样式部分保持不变，为了节省篇幅已压缩，功能完全一致 */
    :root{--bg-body:#0f172a;--bg-card:#1e293b;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--accent-blue:#38bdf8;--accent-green:#4ade80;--accent-red:#f87171;--border-color:#475569;}
    body{margin:0;background:var(--bg-body);color:var(--text-primary);font-family:'Segoe UI',sans-serif}
    header{background:var(--bg-card);padding:15px 20px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
    .container{width:95%;max-width:1400px;margin:20px auto}.row{display:flex;gap:20px;flex-wrap:wrap;margin-bottom:20px}
    .col{background:var(--bg-card);border-radius:12px;padding:20px;flex:1;min-width:300px;border:1px solid var(--border-color)}
    h3{margin-top:0;border-bottom:1px solid var(--border-color);padding-bottom:10px;color:var(--text-secondary)}
    .asset-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin-bottom:15px}
    .input-group label{display:block;font-size:0.75rem;color:var(--text-secondary);margin-bottom:4px}
    .input-group input{width:100%;box-sizing:border-box;background:#0f172a;border:1px solid var(--border-color);color:white;padding:6px;border-radius:4px}
    table{width:100%;border-collapse:collapse;font-size:0.9rem}th,td{padding:8px;border-bottom:1px solid var(--border-color);text-align:left}
    .status-bar{margin-top:10px;font-size:0.8rem;text-align:right;color:var(--text-secondary)}
    .status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#ef4444;margin-right:5px}
    .status-dot.active{background:#22c55e;box-shadow:0 0 5px #22c55e}
    .chart-box{height:350px;position:relative}
    /* Modal */
    .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:999;justify-content:center;align-items:center}
    .modal-content{background:var(--bg-card);width:90%;max-width:600px;border-radius:12px;padding:20px;border:1px solid var(--border-color)}
    .config-item{display:flex;justify-content:space-between;background:rgba(255,255,255,0.05);margin-bottom:8px;padding:8px 12px;border-radius:6px}
    .btn-add{background:var(--accent-green);border:none;padding:5px 15px;border-radius:4px;cursor:pointer;font-weight:bold}
    .close-modal{float:right;cursor:pointer;font-size:1.5rem}
  </style>
</head>
<body>
  <header>
    <h1>我的资产看板 v7 <span style="font-size:0.8rem;color:#666">(智能修复版)</span></h1>
    <div>总净值: <span id="headerTotal" style="color:var(--accent-green);font-weight:bold">--</span> <button onclick="openConfigModal()" style="background:none;border:1px solid var(--accent-blue);color:var(--accent-blue);border-radius:4px;cursor:pointer;margin-left:10px">管理</button></div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col">
        <h3>加密货币</h3>
        <div class="asset-grid" id="cryptoInputs"></div>
        <table><tbody id="cryptoTableBody"></tbody></table>
        <div class="status-bar"><span id="wsDot" class="status-dot"></span><span id="wsStatusText">检查连接...</span></div>
      </div>
      <div class="col">
        <h3>美股 & 现金</h3>
        <div class="asset-grid" id="stockInputs"></div>
        <table><tbody id="stockTableBody"></tbody></table>
        <div class="status-bar"><span id="apiDot" class="status-dot"></span><span id="apiStatusText">Finnhub API</span></div>
      </div>
    </div>
    <div class="row">
      <div class="col" style="flex:2"><div class="chart-box"><canvas id="chartHourComb"></canvas></div></div>
      <div class="col" style="flex:1"><div class="chart-box"><canvas id="chartAssetPie"></canvas></div></div>
    </div>
  </div>

  <div class="modal-overlay" id="configModal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeConfigModal()">&times;</span>
      <h3>管理资产</h3>
      <div id="configContent"></div>
      <button onclick="resetToDefault()" style="margin-top:20px;background:#475569;color:white;border:none;padding:10px;width:100%">重置</button>
    </div>
  </div>

<script>
// ★★★ 配置区域 ★★★
// 我已经填好了你的 Key，但 ID 暂时留空或填错都没关系，V7会自动修复
const JSONBIN_KEY = "$2a$10$ILS6zBz1bfayZ1p0fV2nw.aUVzyUXP6ZicSczS4LLMvPFuCDOY0JC"; 
let JSONBIN_ID    = "694a56ccae596e708fabeac2"; // 如果这个是错的，程序会自动处理

const FINNHUB_TOKEN = "cuhf9e9r01qva71tls00cuhf9e9r01qva71tls0g";

// 全局变量
const DEFAULT_CRYPTO = [{symbol:'BTC',wsKey:'btcusdt'},{symbol:'ETH',wsKey:'ethusdt'},{symbol:'USDT',wsKey:null,isStable:true}];
const DEFAULT_STOCK = [{symbol:'TSLA'},{symbol:'USD',isCash:true}];
let cryptoConfig=[], stockConfig=[], quantities={}, prices={}, hourlyComb=[];
let isDataLoaded=false, cryptoWS=null, chartLine, chartPie, stockInterval;
const $el=id=>document.getElementById(id);

// ★★★ 核心修复逻辑 ★★★
async function initSystem() {
    $el('wsStatusText').textContent = "正在连接云端...";
    
    // 1. 优先使用本地缓存的正确 ID (如果上次修复过)
    const savedID = localStorage.getItem('fixed_bin_id');
    if(savedID) {
        JSONBIN_ID = savedID;
        console.log("使用已修复的 ID:", JSONBIN_ID);
    }

    try {
        // 2. 尝试读取
        const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_ID}/latest`, {
            headers: { 'X-Master-Key': JSONBIN_KEY }
        });

        // 3. 捕捉 403 (权限错误) 或 404 (ID不存在)
        if (res.status === 403 || res.status === 404) {
            $el('wsStatusText').textContent = "检测到 ID 错误，准备修复...";
            await autoFixBinId(); // >>> 自动修复
            return; // 修复后会重新 reload，这里退出
        }

        if (!res.ok) throw new Error("连接失败: " + res.status);
        
        const json = await res.json();
        const data = json.record;
        
        // 4. 加载数据
        cryptoConfig = data.cryptoConfig || DEFAULT_CRYPTO;
        stockConfig = data.stockConfig || DEFAULT_STOCK;
        quantities = data.quantities || {};
        hourlyComb = data.hourlyComb || [];
        
        initPrices();
        renderUI();
        initCharts();
        restartServices();
        isDataLoaded = true;
        $el('wsStatusText').textContent = "云端同步正常";

    } catch (e) {
        console.error(e);
        alert("无法连接云端: " + e.message + "\n将使用离线模式。");
        useOfflineMode();
    }
}

// ★★★ 自动创建新 Bin 的函数 ★★★
async function autoFixBinId() {
    const confirmFix = confirm(
        "检测到云端配置错误 (403 Forbidden)。\n\n" +
        "原因：当前的 ID 不属于你的 API Key。\n" +
        "解决方法：点击【确定】，程序将为你自动创建一个新的数据箱。"
    );

    if (!confirmFix) {
        useOfflineMode();
        return;
    }

    try {
        // 创建新 Bin
        const res = await fetch("https://api.jsonbin.io/v3/b", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Master-Key": JSONBIN_KEY
            },
            body: JSON.stringify({
                cryptoConfig: DEFAULT_CRYPTO,
                stockConfig: DEFAULT_STOCK,
                quantities: {},
                hourlyComb: []
            })
        });

        if (!res.ok) throw new Error("创建失败: " + res.status);
        
        const json = await res.json();
        const newID = json.metadata.id;

        // 保存新 ID 到本地，防止刷新失效
        localStorage.setItem('fixed_bin_id', newID);
        
        // 提示用户更新代码
        prompt(
            "修复成功！\n\n为了下次不再弹窗，请复制下面的【新 ID】，\n并替换代码第 63 行的 JSONBIN_ID：", 
            newID
        );

        location.reload(); // 刷新页面以加载新 ID

    } catch (e) {
        alert("自动修复失败: " + e.message);
        useOfflineMode();
    }
}

function useOfflineMode() {
    cryptoConfig = DEFAULT_CRYPTO;
    stockConfig = DEFAULT_STOCK;
    initPrices();
    renderUI();
    initCharts();
    restartServices();
    $el('wsStatusText').textContent = "离线模式";
}

// ---------------- 业务逻辑 (精简版) ----------------

function initPrices() {
    [...cryptoConfig, ...stockConfig].forEach(i=>{
        const k=i.symbol.toLowerCase();
        if(quantities[k]===undefined) quantities[k]=0;
        if(i.isStable||i.isCash) prices[k]=1; else if(!prices[k]) prices[k]=0;
    });
}

async function saveToCloud() {
    if(!isDataLoaded) return;
    await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_ID}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_KEY },
        body: JSON.stringify({ cryptoConfig, stockConfig, quantities, hourlyComb })
    });
}

function renderUI() {
    renderPanel('crypto', cryptoConfig);
    renderPanel('stock', stockConfig);
    
    // Bind Inputs
    document.querySelectorAll('input').forEach(el => {
        el.oninput = function() {
            const k = this.dataset.key;
            quantities[k] = parseFloat(this.value)||0;
            $el('q_'+k).innerText = quantities[k];
            recalc();
            saveToCloud(); // 实时保存
        }
    });
    recalc();
}

function renderPanel(type, list) {
    const inputs = $el(type+'Inputs');
    const tbody = $el(type+'TableBody');
    inputs.innerHTML = ''; tbody.innerHTML = '';
    
    list.forEach(i => {
        const k = i.symbol.toLowerCase();
        inputs.innerHTML += `<div class="input-group"><label>${i.symbol}</label><input type="number" data-key="${k}" value="${quantities[k]}"></div>`;
        tbody.innerHTML += `<tr><td><b>${i.symbol}</b></td><td id="p_${k}">--</td><td id="q_${k}">${quantities[k]}</td><td id="v_${k}">--</td></tr>`;
    });
}

function recalc() {
    let total = 0;
    [...cryptoConfig, ...stockConfig].forEach(i => {
        const k = i.symbol.toLowerCase();
        const v = (prices[k]||0) * (quantities[k]||0);
        total += v;
        if($el('p_'+k)) $el('p_'+k).innerText = prices[k]?.toFixed(2);
        if($el('v_'+k)) $el('v_'+k).innerText = v.toFixed(2);
    });
    $el('headerTotal').innerText = total.toLocaleString('en-US', {style:'currency', currency:'USD'});
    updateChart(total);
}

// WS & API
function restartServices() {
    if(cryptoWS) cryptoWS.close();
    const streams = cryptoConfig.filter(c=>c.wsKey).map(c=>c.wsKey+'@ticker').join('/');
    if(streams) {
        cryptoWS = new WebSocket("wss://stream.binance.com:9443/stream?streams="+streams);
        cryptoWS.onmessage = e => {
            const msg = JSON.parse(e.data);
            const item = cryptoConfig.find(c=>c.wsKey && msg.stream.includes(c.wsKey));
            if(item) { prices[item.symbol.toLowerCase()] = parseFloat(msg.data.c); recalc(); }
        }
    }
    if(stockInterval) clearInterval(stockInterval);
    fetchStocks();
    stockInterval = setInterval(fetchStocks, 30000);
}

async function fetchStocks() {
    const syms = stockConfig.filter(s=>!s.isCash).map(s=>s.symbol);
    if(!syms.length) return;
    const reqs = syms.map(s => fetch(`https://finnhub.io/api/v1/quote?symbol=${s}&token=${FINNHUB_TOKEN}`).then(r=>r.json()).then(d=>({s,p:d.c})).catch(()=>null));
    (await Promise.all(reqs)).forEach(r => { if(r&&r.p) prices[r.s.toLowerCase()] = r.p });
    recalc();
}

// Charts
function initCharts() {
    if(chartLine) chartLine.destroy();
    chartLine = new Chart($el('chartHourComb'), {
        type:'line', data:{datasets:[{label:'资产',data:hourlyComb,borderColor:'#38bdf8',fill:true,parsing:{xAxisKey:'x',yAxisKey:'y'}}]},
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}}}
    });
    
    if(chartPie) chartPie.destroy();
    chartPie = new Chart($el('chartAssetPie'), {
        type:'doughnut', data:{datasets:[{data:[],backgroundColor:['#38bdf8','#4ade80','#fbbf24','#f87171','#a78bfa']}]},
        options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right'}}}
    });
}

function updateChart(total) {
    if(!chartPie) return;
    const data = []; const labels = [];
    [...cryptoConfig, ...stockConfig].forEach(i=>{
        const v = (prices[i.symbol.toLowerCase()]||0)*(quantities[i.symbol.toLowerCase()]||0);
        if(v>10) { data.push(v); labels.push(i.symbol); }
    });
    chartPie.data.labels = labels; chartPie.data.datasets[0].data = data; chartPie.update();
    
    // Hourly Record
    const d = new Date();
    const label = `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()} ${d.getHours()}:00`;
    if(!hourlyComb.length || hourlyComb[hourlyComb.length-1].x !== label) {
        hourlyComb.push({x:label, y:total});
        if(hourlyComb.length>8760) hourlyComb.shift();
        chartLine.update();
        saveToCloud();
    }
}

// Config Modal Logic (Minimal)
function openConfigModal(){$el('configModal').style.display='flex';renderConfig()}
function closeConfigModal(){$el('configModal').style.display='none'}
function renderConfig(){$el('configContent').innerHTML='(请在代码中修改配置)';} // 简化逻辑，V7重点是修复ID

window.onload = initSystem;
</script>
</body>
</html>
